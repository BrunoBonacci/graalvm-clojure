(ns simple.main
  (:require [clojure.pprint :refer [pprint]]
            [asami.core :as asami])
  (:gen-class))

(def data 
  [{"layers" {"frame" {"frame.protocols" "eth:ethertype:ip:udp:dns", "frame.cap_len" "116", "frame.marked" "0", "frame.offset_shift" "0.000000000", "frame.time_delta_displayed" "0.000930000", "frame.time_relative" "7.513039000", "frame.time_delta" "0.000930000", "frame.time_epoch" "1612222672.715773000", "frame.time" "Feb  1, 2021 18:37:52.715773000 EST", "frame.encap_type" "1", "frame.len" "124", "frame.number" "573", "frame.ignored" "0"}, "eth" {"eth.dst" "46:eb:d7:d5:2b:c8", "eth.dst_tree" {"eth.dst.oui" "4647895", "eth.addr" "46:eb:d7:d5:2b:c8", "eth.dst_resolved" "46:eb:d7:d5:2b:c8", "eth.dst.ig" "0", "eth.ig" "0", "eth.lg" "1", "eth.addr_resolved" "46:eb:d7:d5:2b:c8", "eth.dst.lg" "1", "eth.addr.oui" "4647895"}, "eth.src" "22:4e:7f:74:55:8d", "eth.src_tree" {"eth.addr" "22:4e:7f:74:55:8d", "eth.ig" "0", "eth.lg" "1", "eth.src.oui" "2248319", "eth.addr_resolved" "22:4e:7f:74:55:8d", "eth.src.lg" "1", "eth.src.ig" "0", "eth.addr.oui" "2248319", "eth.src_resolved" "22:4e:7f:74:55:8d"}, "eth.type" "0x00000800"}, "ip" {"ip.checksum.status" "2", "ip.dst_host" "192.168.1.122", "ip.host" "192.168.1.122", "ip.dsfield" "0x00000000", "ip.version" "4", "ip.len" "110", "ip.src" "192.168.1.1", "ip.addr" "192.168.1.122", "ip.frag_offset" "0", "ip.dsfield_tree" {"ip.dsfield.dscp" "0", "ip.dsfield.ecn" "0"}, "ip.ttl" "64", "ip.checksum" "0x000083a1", "ip.id" "0x00003312", "ip.proto" "17", "ip.flags_tree" {"ip.flags.rb" "0", "ip.flags.df" "1", "ip.flags.mf" "0"}, "ip.hdr_len" "20", "ip.dst" "192.168.1.122", "ip.src_host" "192.168.1.1", "ip.flags" "0x00000040"}, "udp" {"udp.checksum.status" "2", "udp.payload" "3a:8f:81:80:00:01:00:02:00:00:00:01:05:61:31:39:35:36:04:64:73:63:62:06:61:6b:61:6d:61:69:03:6e:65:74:00:00:01:00:01:c0:0c:00:01:00:01:00:00:00:3c:00:04:68:7e:74:ab:c0:0c:00:01:00:01:00:00:00:3c:00:04:68:7e:74:c9:00:00:29", "udp.port" "59865", "udp.checksum" "0x00008437", "Timestamps" {"udp.time_relative" "0.034204000", "udp.time_delta" "0.034204000"}, "udp.dstport" "59865", "udp.srcport" "53", "udp.length" "90", "udp.stream" "23"}, "dns" {"Answers" {"a1956.dscb.akamai.net: type A, class IN, addr 104.126.116.171" {"dns.resp.name" "a1956.dscb.akamai.net", "dns.resp.type" "1", "dns.resp.class" "0x00000001", "dns.resp.ttl" "60", "dns.resp.len" "4", "dns.a" "104.126.116.171"}, "a1956.dscb.akamai.net: type A, class IN, addr 104.126.116.201" {"dns.resp.name" "a1956.dscb.akamai.net", "dns.resp.type" "1", "dns.resp.class" "0x00000001", "dns.resp.ttl" "60", "dns.resp.len" "4", "dns.a" "104.126.116.201"}}, "dns.flags_tree" {"dns.flags.recdesired" "1", "dns.flags.authoritative" "0", "dns.flags.response" "1", "dns.flags.truncated" "0", "dns.flags.z" "0", "dns.flags.recavail" "1", "dns.flags.checkdisable" "0", "dns.flags.opcode" "0", "dns.flags.authenticated" "0", "dns.flags.rcode" "0"}, "dns.count.queries" "1", "dns.flags" "0x00008180", "dns.count.auth_rr" "0", "Queries" {"a1956.dscb.akamai.net: type A, class IN" {"dns.qry.name" "a1956.dscb.akamai.net", "dns.qry.name.len" "21", "dns.count.labels" "4", "dns.qry.type" "1", "dns.qry.class" "0x00000001"}}, "dns.count.answers" "2", "Additional records" "", "dns.id" "0x00003a8f", "dns.count.add_rr" "1"}, "_ws.short" "[Packet size limited during capture: DNS truncated]"}}])

(defn -main []
  (let [conn (asami/connect "asami:mem://data")
        db (:db-after @(asami/transact conn {:tx-data data}))]
    (pprint (asami/q '[:find [?a ...] :where [?e ?a ?v][(string? ?a)][(re-find #" " ?a)]] db)))
  (System/exit 0))

